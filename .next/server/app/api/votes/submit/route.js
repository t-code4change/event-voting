"use strict";(()=>{var e={};e.id=7888,e.ids=[7888],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},52852:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>v,patchFetch:()=>g,requestAsyncStorage:()=>l,routeModule:()=>u,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m});var o={};s.r(o),s.d(o,{POST:()=>c});var r=s(49303),n=s(88716),a=s(60670),i=s(87070),d=s(19692);async function c(e){try{let{voter_id:t,event_id:s,votes:o}=await e.json();if(!t||!s||!o||!Array.isArray(o))return i.NextResponse.json({message:"Invalid request data"},{status:400});let r=(0,d.e)(),{data:n,error:a}=await r.from("voters").select("id, event_id").eq("id",t).eq("event_id",s).single();if(a||!n){if(t.startsWith("mock-voter-"))return console.log("Mock voter detected, allowing vote submission in demo mode"),i.NextResponse.json({message:"Votes submitted successfully (demo mode - not saved to database)",success:!0});return i.NextResponse.json({message:"Voter not found"},{status:404})}let{data:c,error:u}=await r.from("events").select("id, voting_start_time, voting_end_time, allow_edit_before_deadline").eq("id",s).single();if(u||!c)return i.NextResponse.json({message:"Event not found"},{status:404});let l=new Date,m=new Date(c.voting_start_time),p=new Date(c.voting_end_time);if(l<m)return i.NextResponse.json({message:"B\xecnh chọn chưa bắt đầu"},{status:400});if(l>p)return i.NextResponse.json({message:"B\xecnh chọn đ\xe3 kết th\xfac"},{status:400});let{data:v}=await r.from("votes").select("id").eq("voter_id",t).limit(1);if(v&&v.length>0&&!c.allow_edit_before_deadline)return i.NextResponse.json({message:"Bạn đ\xe3 b\xecnh chọn rồi v\xe0 kh\xf4ng thể sửa đổi"},{status:400});for(let e of o){let{data:t,error:o}=await r.from("categories").select("id, max_votes_per_voter").eq("id",e.category_id).eq("event_id",s).single();if(o||!t)return i.NextResponse.json({message:`Category ${e.category_id} not found`},{status:400});if(e.candidate_ids.length>t.max_votes_per_voter)return i.NextResponse.json({message:`Bạn chỉ c\xf3 thể chọn tối đa ${t.max_votes_per_voter} ứng vi\xean cho danh mục n\xe0y`},{status:400});for(let t of e.candidate_ids){let{data:s,error:o}=await r.from("candidates").select("id").eq("id",t).eq("category_id",e.category_id).single();if(o||!s)return i.NextResponse.json({message:`Candidate ${t} not found in this category`},{status:400})}}c.allow_edit_before_deadline&&await r.from("votes").delete().eq("voter_id",t);let g=o.flatMap(e=>e.candidate_ids.map(o=>({voter_id:t,event_id:s,category_id:e.category_id,candidate_id:o}))),{error:_}=await r.from("votes").insert(g);if(_)return console.error("Error inserting votes:",_),i.NextResponse.json({message:"Failed to submit votes"},{status:500});return await r.from("voters").update({voted_at:new Date().toISOString()}).eq("id",t),i.NextResponse.json({message:"Votes submitted successfully",success:!0})}catch(e){return console.error("Error in submit votes route:",e),i.NextResponse.json({message:"Internal server error"},{status:500})}}let u=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/votes/submit/route",pathname:"/api/votes/submit",filename:"route",bundlePath:"app/api/votes/submit/route"},resolvedPagePath:"/Users/tuanpham/MyLife/CRM-Pacificwide/event-voting/app/api/votes/submit/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:p}=u,v="/api/votes/submit/route";function g(){return(0,a.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}},19692:(e,t,s)=>{s.d(t,{e:()=>n});var o=s(75117),r=s(71615);function n(){let e=(0,r.cookies)();return(0,o.lx)("https://xicdommyxzsschupzvsx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpY2RvbW15eHpzc2NodXB6dnN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTc3NzcsImV4cCI6MjA3Nzg5Mzc3N30.MAmu4KlsDw-GuE_PT6ApiBq58eH3r8xnbcuQjQ4PzME",{cookies:{get:t=>e.get(t)?.value,set(t,s,o){try{e.set({name:t,value:s,...o})}catch(e){}},remove(t,s){try{e.set({name:t,value:"",...s})}catch(e){}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),o=t.X(0,[9276,9564,5117],()=>s(52852));module.exports=o})();