"use strict";(()=>{var e={};e.id=490,e.ids=[490],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8928:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>h,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l});var s={};r.r(s),r.d(s,{POST:()=>c});var i=r(9303),o=r(8716),a=r(670),n=r(7070),u=r(9692);async function c(e){try{let t;let{event_id:r,email:s,phone:i,otp:o}=await e.json();if(!r||!o)return n.NextResponse.json({message:"Event ID and OTP are required"},{status:400});if(!s&&!i)return n.NextResponse.json({message:"Email or phone is required"},{status:400});let a=(0,u.e)(),c=a.from("otp_codes").select("*").eq("event_id",r).eq("code",o).eq("is_used",!1).gt("expires_at",new Date().toISOString()).order("created_at",{ascending:!1}).limit(1);s&&(c=c.eq("email",s)),i&&(c=c.eq("phone",i));let{data:p,error:d}=await c.single();if(d||!p)return n.NextResponse.json({message:"M\xe3 OTP kh\xf4ng hợp lệ hoặc đ\xe3 hết hạn"},{status:400});await a.from("otp_codes").update({is_used:!0}).eq("id",p.id);let l=a.from("voters").select("id").eq("event_id",r);s&&(l=l.eq("email",s)),i&&(l=l.eq("phone",i));let{data:m}=await l.single();if(m)t=m.id;else{let{data:e,error:o}=await a.from("voters").insert({event_id:r,email:s,phone:i,is_verified:!0}).select("id").single();if(o||!e)return console.error("Error creating voter:",o),n.NextResponse.json({message:"Failed to create voter"},{status:500});t=e.id}return n.NextResponse.json({message:"Verification successful",voter_id:t})}catch(e){return console.error("Error in verify-otp route:",e),n.NextResponse.json({message:"Internal server error"},{status:500})}}let p=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/verify-otp/route",pathname:"/api/auth/verify-otp",filename:"route",bundlePath:"app/api/auth/verify-otp/route"},resolvedPagePath:"/Users/tuanpham/MyLife/CRM-Pacificwide/event-voting/app/api/auth/verify-otp/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:m}=p,v="/api/auth/verify-otp/route";function h(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}},9692:(e,t,r)=>{r.d(t,{e:()=>o});var s=r(5117),i=r(1615);function o(){let e=(0,i.cookies)();return(0,s.lx)("https://xicdommyxzsschupzvsx.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpY2RvbW15eHpzc2NodXB6dnN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTc3NzcsImV4cCI6MjA3Nzg5Mzc3N30.MAmu4KlsDw-GuE_PT6ApiBq58eH3r8xnbcuQjQ4PzME",{cookies:{get:t=>e.get(t)?.value,set(t,r,s){try{e.set({name:t,value:r,...s})}catch(e){}},remove(t,r){try{e.set({name:t,value:"",...r})}catch(e){}}}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,615,972,117],()=>r(8928));module.exports=s})();