"use client"

import { useState, useEffect } from "react"
import Header from "@/components/Header"
import AuthModal from "@/components/AuthModal"
import CategoryVotingCard from "@/components/CategoryVotingCard"
import ConfettiEffect from "@/components/ConfettiEffect"
import { Button } from "@/components/ui/button"
import { Card, CardContent } from "@/components/ui/card"
import { CheckCircle2, Loader2 } from "lucide-react"
import { toast } from "sonner"
import { Category, VotesByCategory } from "@/types/voting"

export default function VotingPage() {
  const [isAuthenticated, setIsAuthenticated] = useState(false)
  const [voterId, setVoterId] = useState<string | null>(null)
  const [showAuthModal, setShowAuthModal] = useState(false)
  const [categories, setCategories] = useState<Category[]>([])
  const [loading, setLoading] = useState(false)
  const [submitting, setSubmitting] = useState(false)
  const [selectedVotes, setSelectedVotes] = useState<VotesByCategory>({})
  const [eventId, setEventId] = useState<string | null>(null)
  const [eventName, setEventName] = useState<string>("")
  const [showConfetti, setShowConfetti] = useState(false)

  useEffect(() => {
    loadActiveEvent()
  }, [])

  useEffect(() => {
    if (eventId) {
      loadCategories()
    }
  }, [eventId])

  const loadActiveEvent = async () => {
    try {
      const response = await fetch("/api/events/active")
      if (response.ok) {
        const data = await response.json()
        setEventId(data.event.id)
        setEventName(data.event.name)
      } else {
        toast.error("Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán ƒëang ho·∫°t ƒë·ªông")
      }
    } catch (error) {
      console.error("Error loading active event:", error)
      toast.error("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·ª± ki·ªán")
    }
  }

  const loadCategories = async () => {
    if (!eventId) return

    setLoading(true)
    try {
      // Load categories and candidates - KH√îNG c·∫ßn ƒëƒÉng nh·∫≠p
      const categoriesResponse = await fetch(`/api/events/${eventId}/categories`)
      if (!categoriesResponse.ok) {
        throw new Error("Failed to load categories")
      }
      const categoriesData = await categoriesResponse.json()

      if (categoriesData.categories && categoriesData.categories.length > 0) {
        setCategories(categoriesData.categories)
      } else {
        toast.error("Kh√¥ng c√≥ danh m·ª•c n√†o")
      }
    } catch (error) {
      console.error("Error loading categories:", error)
      toast.error("Kh√¥ng th·ªÉ t·∫£i danh m·ª•c b√¨nh ch·ªçn")
    } finally {
      setLoading(false)
    }
  }

  const handleAuthSuccess = async (id: string) => {
    setVoterId(id)
    setIsAuthenticated(true)
    setShowAuthModal(false)

    // Load existing votes if any
    try {
      const votesResponse = await fetch(`/api/votes/voter/${id}`)
      if (votesResponse.ok) {
        const votesData = await votesResponse.json()
        // Merge v·ªõi votes ƒë√£ ch·ªçn tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p
        setSelectedVotes((prev) => ({
          ...votesData.votes,
          ...prev, // ∆Øu ti√™n votes m·ªõi ch·ªçn
        }))
      }
    } catch (error) {
      console.error("Error loading existing votes:", error)
    }

    // Sau khi ƒëƒÉng nh·∫≠p xong, t·ª± ƒë·ªông submit votes
    await submitVotes(id)
  }

  const toggleCandidate = (categoryId: string, candidateId: string) => {
    setSelectedVotes((prev) => {
      const categoryVotes = prev[categoryId] || []
      const isSelected = categoryVotes.includes(candidateId)

      if (isSelected) {
        // Deselect
        return {
          ...prev,
          [categoryId]: categoryVotes.filter((id) => id !== candidateId),
        }
      } else {
        // Select
        return {
          ...prev,
          [categoryId]: [...categoryVotes, candidateId],
        }
      }
    })
  }

  const handleSubmit = async () => {
    // Check if user has made any selections
    const hasVotes = Object.values(selectedVotes).some(
      (votes) => votes.length > 0
    )

    if (!hasVotes) {
      toast.error("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ·ª©ng vi√™n")
      return
    }

    // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, hi·ªán modal ƒëƒÉng nh·∫≠p
    if (!isAuthenticated || !voterId) {
      setShowAuthModal(true)
      return
    }

    // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, submit tr·ª±c ti·∫øp
    await submitVotes(voterId)
  }

  const submitVotes = async (voterIdParam: string) => {
    setSubmitting(true)

    try {
      const votes = Object.entries(selectedVotes)
        .filter(([_, candidateIds]) => candidateIds.length > 0)
        .map(([categoryId, candidateIds]) => ({
          category_id: categoryId,
          candidate_ids: candidateIds,
        }))

      const response = await fetch("/api/votes/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          voter_id: voterIdParam,
          event_id: eventId,
          votes,
        }),
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.message || "G·ª≠i b√¨nh ch·ªçn th·∫•t b·∫°i")
      }

      toast.success("B√¨nh ch·ªçn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n!")

      // Show confetti celebration
      setShowConfetti(true)

      // Optionally redirect to results page
      // router.push('/results')
    } catch (error) {
      console.error("Error submitting votes:", error)
      toast.error(error instanceof Error ? error.message : "C√≥ l·ªói x·∫£y ra")
    } finally {
      setSubmitting(false)
    }
  }

  const getTotalSelectedVotes = () => {
    return Object.values(selectedVotes).reduce(
      (sum, votes) => sum + votes.length,
      0
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-[#0B0B0B] via-[#1a1a1a] to-[#0B0B0B]">
      <Header />

      {/* Confetti Effect */}
      <ConfettiEffect show={showConfetti} duration={5000} />

      <div className="container px-4 py-8 max-w-6xl">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div>
              <h1 className="text-3xl md:text-4xl font-bold mb-2 text-white">
                B√¨nh ch·ªçn
              </h1>
              <p className="text-[#FAF3E0]/70">
                Ch·ªçn ·ª©ng vi√™n y√™u th√≠ch c·ªßa b·∫°n
              </p>
            </div>
            {/* TODO: Add countdown timer */}
            {/* <Badge variant="destructive" className="px-4 py-2">
              <Clock className="mr-2 h-4 w-4" />
              C√≤n --:--
            </Badge> */}
          </div>
        </div>

        {/* Auth Modal */}
        {eventId && (
          <AuthModal
            isOpen={showAuthModal}
            onClose={() => setShowAuthModal(false)}
            onSuccess={handleAuthSuccess}
            eventId={eventId}
          />
        )}

        {/* Loading State */}
        {loading ? (
          <div className="flex items-center justify-center py-16">
            <Loader2 className="h-12 w-12 animate-spin text-[#FFD700]" />
          </div>
        ) : categories.length === 0 ? (
          /* No Categories State */
          <Card className="max-w-2xl mx-auto border-2 border-[#FFD700]/20 bg-[#1a1a1a]">
            <CardContent className="p-12 text-center space-y-4">
              <h2 className="text-2xl font-bold mb-2 text-white">
                Ch∆∞a c√≥ danh m·ª•c n√†o
              </h2>
              <p className="text-[#FAF3E0]/70">
                S·ª± ki·ªán n√†y ch∆∞a c√≥ danh m·ª•c b√¨nh ch·ªçn
              </p>
            </CardContent>
          </Card>
        ) : (
          /* Voting Interface - Hi·ªÉn th·ªã ngay kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p */
          <div className="space-y-8">
            {categories.map((category) => (
              <CategoryVotingCard
                key={category.id}
                category={category}
                selectedCandidates={selectedVotes[category.id] || []}
                onToggleCandidate={(candidateId) =>
                  toggleCandidate(category.id, candidateId)
                }
              />
            ))}

            {/* Submit Button */}
            <div className="flex flex-col items-center gap-4">
              <div className="text-center">
                <p className="text-sm text-[#FAF3E0]/70 mb-2">
                  T·ªïng s·ªë phi·∫øu ƒë√£ ch·ªçn: {getTotalSelectedVotes()}
                </p>
                {!isAuthenticated && getTotalSelectedVotes() > 0 && (
                  <p className="text-xs text-[#FFE68A] mt-1">
                    üí° B·∫°n s·∫Ω c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i b√¨nh ch·ªçn
                  </p>
                )}
              </div>
              <Button
                size="lg"
                className="px-12 rounded-full bg-gradient-to-r from-[#FFD700] to-[#FDB931] hover:from-[#FDB931] hover:to-[#FFD700] text-black font-semibold shadow-lg hover:shadow-[#FFD700]/50 transition-all duration-300"
                disabled={submitting || getTotalSelectedVotes() === 0}
                onClick={handleSubmit}
              >
                {submitting ? (
                  <>
                    <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                    ƒêang g·ª≠i...
                  </>
                ) : (
                  <>
                    <CheckCircle2 className="mr-2 h-5 w-5" />
                    {!isAuthenticated ? "ƒêƒÉng nh·∫≠p & G·ª≠i b√¨nh ch·ªçn" : "X√°c nh·∫≠n b√¨nh ch·ªçn"}
                  </>
                )}
              </Button>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
